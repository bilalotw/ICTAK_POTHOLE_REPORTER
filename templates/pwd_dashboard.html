{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h3>PWD Dashboard</h3>
</div>

<div class="row">
  <div class="col-md-7">
    <div id="map"></div>
  </div>
  <div class="col-md-5">
    <h5>Reports</h5>
    <table class="table table-sm table-bordered align-middle">
      <thead>
        <tr>
          <th>Image</th>
          <th>Desc</th>
          <th>Loc</th>
          <th>By</th>
          <th>Status</th>
          <th>Comment</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reports %}
        <tr data-id="{{ r._id }}">
          <td><img src="{{ r.image_url }}" width="80"></td>
          <td>{{ r.description or 'N/A' }}</td>
          <td>{{ r.latitude }}, {{ r.longitude }}</td>
          <td>{{ r.reported_by_username or 'N/A' }}</td>
          <td>
            <select class="form-select form-select-sm status-select">
              <option value="Pending" {% if r.status == 'Pending' %}selected{% endif %}>Pending</option>
              <option value="In Progress" {% if r.status == 'In Progress' %}selected{% endif %}>In Progress</option>
              <option value="Resolved" {% if r.status == 'Resolved' %}selected{% endif %}>Resolved</option>
            </select>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm comment-input" placeholder="Add comment">
          </td>
          <td>
            <button class="btn btn-sm btn-primary update-btn">Update</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
window.addEventListener('load', function(){
  var reports = {{ reports|tojson|safe }};

  // Leaflet map
  var map = L.map('map').setView([20.5937,78.9629], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  if (reports && reports.length) {
    reports.forEach(function(r){
      var m = L.marker([r.latitude, r.longitude]).addTo(map);
      var popup = '<div><img src="' + r.image_url + '" class="thumb mb-1"><br/>' +
                  '<strong>' + r.status + '</strong><br/>' +
                  '<small>' + r.timestamp + '</small><br/>' +
                  '<div>By: ' + (r.reported_by_username || 'unknown') + '</div>' +
                  '<a href="/report/' + r._id + '" target="_blank">Open</a></div>';
      m.bindPopup(popup);
    });
    map.setView([reports[0].latitude, reports[0].longitude], 12);
  }

  // Handle update button click
  document.querySelectorAll('.update-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var row = btn.closest('tr');
      var reportId = row.getAttribute('data-id');
      var status = row.querySelector('.status-select').value;
      var comment = row.querySelector('.comment-input').value;

      fetch('/pwd/update_status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          report_id: reportId,
          status: status,
          comment: comment
        })
      }).then(res => res.json())
      .then(data => {
        if (data.ok) {
          alert('Status updated successfully!');
        } else {
          alert('Error: ' + (data.error || 'unknown'));
        }
      });
    });
  });

});
</script>
{% endblock %}
